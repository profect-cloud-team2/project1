<!-- index.html -->
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ê²°ì œí•˜ê¸°</title>
    <script src="https://js.tosspayments.com/v1/payment"></script>
</head>
<body>
<style>
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }

    body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background-color: #f5f5f5;
        padding: 20px;
    }

    .container {
        max-width: 500px;
        margin: 0 auto;
        background: white;
        border-radius: 12px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        overflow: hidden;
    }

    .header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 20px;
        text-align: center;
    }

    .header h1 {
        font-size: 24px;
        margin-bottom: 5px;
    }

    .header p {
        opacity: 0.9;
        font-size: 14px;
    }

    .order-section {
        padding: 20px;
    }

    .menu-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 15px;
        border: 2px solid #e9ecef;
        border-radius: 8px;
        margin-bottom: 15px;
        background: #f8f9fa;
    }

    .menu-info {
        flex: 1;
    }

    .menu-name {
        font-size: 18px;
        font-weight: 600;
        color: #333;
        margin-bottom: 5px;
    }

    .menu-price {
        font-size: 16px;
        color: #666;
    }

    .quantity-control {
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .quantity-btn {
        width: 35px;
        height: 35px;
        border: none;
        border-radius: 50%;
        background: #667eea;
        color: white;
        font-size: 18px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .quantity-btn:hover {
        background: #5a6fd8;
    }

    .quantity-btn:disabled {
        background: #ccc;
        cursor: not-allowed;
    }

    .quantity {
        font-size: 18px;
        font-weight: 600;
        min-width: 30px;
        text-align: center;
    }

    .total-section {
        padding: 20px;
        border-top: 2px solid #e9ecef;
        background: #f8f9fa;
    }

    .total-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
    }

    .total-label {
        font-size: 16px;
        color: #666;
    }

    .total-amount {
        font-size: 24px;
        font-weight: 700;
        color: #333;
    }

    .button-section {
        padding: 20px;
        display: flex;
        gap: 10px;
    }

    .btn {
        flex: 1;
        padding: 15px;
        border: none;
        border-radius: 8px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .btn-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
    }

    .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }

    .btn-secondary {
        background: #6c757d;
        color: white;
    }

    .btn-secondary:hover {
        background: #5a6268;
        transform: translateY(-2px);
    }

    .loading {
        display: none;
        text-align: center;
        padding: 20px;
        color: #666;
    }

    .spinner {
        border: 3px solid #f3f3f3;
        border-top: 3px solid #667eea;
        border-radius: 50%;
        width: 30px;
        height: 30px;
        animation: spin 1s linear infinite;
        margin: 0 auto 10px;
    }

    @keyframes spin {
        0% {
            transform: rotate(0deg);
        }
        100% {
            transform: rotate(360deg);
        }
    }
</style>

<div class="container">
    <div class="header">
        <h1>ğŸ• ì£¼ë¬¸ ê²°ì œ</h1>
        <p>ë§›ìˆëŠ” ìŒì‹ì„ ì£¼ë¬¸í•´ë³´ì„¸ìš”!</p>
        <p style="font-size: 12px; margin-top: 10px; opacity: 0.8;">ë¡œê·¸ì¸ì´ í•„ìš”í•œ ì„œë¹„ìŠ¤ì…ë‹ˆë‹¤</p>
    </div>

    <div class="order-section" id="orderSection">
        <div class="loading-cart" id="loadingCart">
            <div class="spinner"></div>
            <p>ì¥ë°”êµ¬ë‹ˆ ë¡œë”© ì¤‘...</p>
        </div>
    </div>

    <div class="total-section">
        <div class="total-row">
            <span class="total-label">ì´ ê²°ì œê¸ˆì•¡</span>
            <span class="total-amount" id="totalAmount">4,500ì›</span>
        </div>
    </div>

    <div class="button-section">
        <button class="btn btn-secondary" onclick="cancelOrder()">ê²°ì œ ì·¨ì†Œ</button>
        <button class="btn btn-primary" onclick="processPayment()">ê²°ì œí•˜ê¸°</button>
    </div>

    <div class="loading" id="loading">
        <div class="spinner"></div>
        <p>ê²°ì œ ì²˜ë¦¬ ì¤‘...</p>
    </div>
</div>

<script>
    let tossPayments;
    let cartItems = [];
    let totalAmount = 0;

    // í´ë¼ì´ì–¸íŠ¸ í‚¤ ê°€ì ¸ì˜¤ê¸°
    console.log('í´ë¼ì´ì–¸íŠ¸ í‚¤ ìš”ì²­ ì‹œì‘...');
    fetch('/api/payment/client-key')
        .then(response => {
            console.log('API ì‘ë‹µ ìƒíƒœ:', response.status, response.statusText);
            if (!response.ok) {
                throw new Error(`í´ë¼ì´ì–¸íŠ¸ í‚¤ ìš”ì²­ ì‹¤íŒ¨: ${response.status} ${response.statusText}`);
            }
            return response.text();
        })
        .then(clientKey => {
            console.log('í´ë¼ì´ì–¸íŠ¸ í‚¤ ê¸¸ì´:', clientKey.length);

            if (!clientKey || !clientKey.trim()) {
                throw new Error('ë¹ˆ í´ë¼ì´ì–¸íŠ¸ í‚¤ ë°›ìŒ');
            }

            const trimmedKey = clientKey.trim();
            console.log('ì •ë¦¬ëœ í´ë¼ì´ì–¸íŠ¸ í‚¤:', trimmedKey);

            try {
                tossPayments = TossPayments(trimmedKey);
            } catch (initError) {
                console.error('TossPayments ì´ˆê¸°í™” ì˜¤ë¥˜:', initError);
                throw new Error('TossPayments ì´ˆê¸°í™” ì‹¤íŒ¨: ' + initError.message);
            }
        })
        .catch(error => {
            console.error('ì „ì²´ ì˜¤ë¥˜:', error);
            console.error('ì˜¤ë¥˜ ìŠ¤íƒ:', error.stack);
            alert('ê²°ì œ ì‹œìŠ¤í…œ ì´ˆê¸°í™” ì‹¤íŒ¨: ' + error.message);
        });

    // ì¥ë°”êµ¬ë‹ˆ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
    function loadCartItems() {
        console.log('ì¥ë°”êµ¬ë‹ˆ ë°ì´í„° ë¡œë“œ ì‹œì‘...');

        fetch('/api/cart', {
            headers: {
                "Authorization": "Bearer " + localStorage.getItem("token")
            }
        })
            .then(response => {
                console.log('API ì‘ë‹µ ìƒíƒœ:', response.status, response.statusText);
                console.log('API ì‘ë‹µ í—¤ë”:', response.headers);

                if (!response.ok) {
                    return response.text().then(text => {
                        console.error('ì˜¤ë¥˜ ì‘ë‹µ ë‚´ìš©:', text);
                        throw new Error(`ì¥ë°”êµ¬ë‹ˆ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨: ${response.status} - ${text}`);
                    });
                }
                return response.json();
            })
            .then(data => {
                console.log('ì¥ë°”êµ¬ë‹ˆ ë°ì´í„°:', data);
                console.log('ë°ì´í„° íƒ€ì…:', typeof data);
                console.log('ë°ì´í„° ê¸¸ì´:', data ? data.length : 'undefined');

                if (data && data.length > 0 && data[0].items && data[0].items.length > 0) {
                    cartItems = data[0].items;
                    console.log('ì¥ë°”êµ¬ë‹ˆ ì•„ì´í…œ ìˆ˜:', cartItems.length);
                    displayCartItems();
                } else {
                    console.log('ë¹ˆ ì¥ë°”êµ¬ë‹ˆ ë˜ëŠ” ë°ì´í„° ì—†ìŒ');
                    displayEmptyCart();
                }
            })
            .catch(error => {
                console.error('ì¥ë°”êµ¬ë‹ˆ ë¡œë“œ ì˜¤ë¥˜:', error);
                console.error('ì˜¤ë¥˜ ìŠ¤íƒ:', error.stack);
                displayEmptyCart();
            });
    }

    function displayCartItems() {
        const orderSection = document.getElementById('orderSection');
        const loadingCart = document.getElementById('loadingCart');

        if (loadingCart) {
            loadingCart.style.display = 'none';
        }

        let itemsHtml = '';
        totalAmount = 0;

        cartItems.forEach((item, index) => {
            const itemTotal = item.price * item.quantity;
            totalAmount += itemTotal;

            itemsHtml += `
                    <div class="menu-item">
                        <div class="menu-info">
                            <div class="menu-name">${item.menuName}</div>
                            <div class="menu-price">${item.price.toLocaleString()}ì›</div>
                        </div>
                        <div class="quantity-control">
                            <button class="quantity-btn" onclick="decreaseQuantity(${index})" ${item.quantity <= 1 ? 'disabled' : ''}>-</button>
                            <span class="quantity">${item.quantity}</span>
                            <button class="quantity-btn" onclick="increaseQuantity(${index})" ${item.quantity >= 10 ? 'disabled' : ''}>+</button>
                        </div>
                    </div>
                `;
        });

        orderSection.innerHTML = itemsHtml;
        updateTotalDisplay();
    }

    function displayEmptyCart() {
        const orderSection = document.getElementById('orderSection');
        const loadingCart = document.getElementById('loadingCart');

        if (loadingCart) {
            loadingCart.style.display = 'none';
        }
        orderSection.innerHTML = `
                <div style="text-align: center; padding: 40px; color: #666;">
                    <p>ì¥ë°”êµ¬ë‹ˆê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.</p>
                    <p>ë¡œê·¸ì¸ í›„ ë©”ë‰´ë¥¼ ë‹´ê³  ê²°ì œí•´ì£¼ì„¸ìš”.</p>
                    <p style="font-size: 12px; color: #999; margin-top: 10px;">
                        ë˜ëŠ” ì¥ë°”êµ¬ë‹ˆë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.
                    </p>
                </div>
            `;

        // ê²°ì œ ë²„íŠ¼ ë¹„í™œì„±í™”
        document.querySelector('.btn-primary').disabled = true;
    }

    function increaseQuantity(index) {
        if (cartItems[index].quantity < 10) {
            updateCartItemQuantity(cartItems[index].cartItemId, cartItems[index].quantity + 1, index);
        }
    }

    function decreaseQuantity(index) {
        if (cartItems[index].quantity > 1) {
            updateCartItemQuantity(cartItems[index].cartItemId, cartItems[index].quantity - 1, index);
        }
    }

    function updateCartItemQuantity(cartItemId, newQuantity, index) {
        fetch(`/api/cart/items/${cartItemId}?quantity=${newQuantity}`, {
            method: 'PATCH',
            headers: {
                "Authorization": "Bearer " + localStorage.getItem("token")
            }
        })
            .then(response => {
                if (response.ok) {
                    cartItems[index].quantity = newQuantity;
                    displayCartItems();
                } else {
                    alert('ìˆ˜ëŸ‰ ì—…ë°ì´íŠ¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
            })
            .catch(error => {
                console.error('ìˆ˜ëŸ‰ ì—…ë°ì´íŠ¸ ì˜¤ë¥˜:', error);
                alert('ìˆ˜ëŸ‰ ì—…ë°ì´íŠ¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            });
    }

    function updateTotalDisplay() {
        document.getElementById('totalAmount').textContent = totalAmount.toLocaleString() + 'ì›';
    }

    function cancelOrder() {
        if (confirm('ì£¼ë¬¸ì„ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
            alert('ì£¼ë¬¸ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.');
            window.history.back();
        }
    }

    function processPayment() {
        if (!tossPayments) {
            alert('ê²°ì œ ì‹œìŠ¤í…œì´ ì•„ì§ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
            return;
        }

        if (cartItems.length === 0) {
            alert('ì¥ë°”êµ¬ë‹ˆê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.');
            return;
        }

        // ë¡œë”© í‘œì‹œ
        document.getElementById('loading').style.display = 'block';
        document.querySelector('.button-section').style.display = 'none';

        // ë¨¼ì € ì„œë²„ì— ê²°ì œ ì¤€ë¹„ ìš”ì²­
        fetch('/api/payment/ready', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': 'Bearer ' + localStorage.getItem('token')
            },
            body: JSON.stringify({
                customerEmail: 'customer@example.com'
            })
        })
            .then(response => response.json())
            .then(paymentData => {
                console.log('ê²°ì œ ì¤€ë¹„ ì‘ë‹µ:', paymentData);

                // ì„œë²„ì—ì„œ ë°›ì€ ë°ì´í„°ë¡œ ê²°ì œ ìš”ì²­
                tossPayments.requestPayment('CARD', {
                    amount: paymentData.amount,
                    orderId: paymentData.orderId,
                    orderName: paymentData.orderName,
                    customerName: 'ê³ ê°',
                    customerEmail: 'customer@example.com',
                    successUrl: 'http://localhost:8080/api/payment/success',
                    failUrl: 'http://localhost:8080/api/payment/fail'
                });
            })
            .catch(error => {
                console.error('ê²°ì œ ì¤€ë¹„ ì˜¤ë¥˜:', error);
                document.getElementById('loading').style.display = 'none';
                document.querySelector('.button-section').style.display = 'flex';
                alert('ê²°ì œ ì¤€ë¹„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
            });
    }

    // ì¥ë°”êµ¬ë‹ˆ ë¡œë“œ
    loadCartItems();
</script>
</body>
</html>
