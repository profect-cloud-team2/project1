<!-- index.html -->
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>결제하기</title>
    <script src="https://js.tosspayments.com/v1/payment"></script>
</head>
<body>
<style>
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }

    body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background-color: #f5f5f5;
        padding: 20px;
    }

    .container {
        max-width: 500px;
        margin: 0 auto;
        background: white;
        border-radius: 12px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        overflow: hidden;
    }

    .header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 20px;
        text-align: center;
    }

    .header h1 {
        font-size: 24px;
        margin-bottom: 5px;
    }

    .header p {
        opacity: 0.9;
        font-size: 14px;
    }

    .order-section {
        padding: 20px;
    }

    .menu-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 15px;
        border: 2px solid #e9ecef;
        border-radius: 8px;
        margin-bottom: 15px;
        background: #f8f9fa;
    }

    .menu-info {
        flex: 1;
    }

    .menu-name {
        font-size: 18px;
        font-weight: 600;
        color: #333;
        margin-bottom: 5px;
    }

    .menu-price {
        font-size: 16px;
        color: #666;
    }

    .quantity-control {
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .quantity-btn {
        width: 35px;
        height: 35px;
        border: none;
        border-radius: 50%;
        background: #667eea;
        color: white;
        font-size: 18px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .quantity-btn:hover {
        background: #5a6fd8;
    }

    .quantity-btn:disabled {
        background: #ccc;
        cursor: not-allowed;
    }

    .quantity {
        font-size: 18px;
        font-weight: 600;
        min-width: 30px;
        text-align: center;
    }

    .total-section {
        padding: 20px;
        border-top: 2px solid #e9ecef;
        background: #f8f9fa;
    }

    .total-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
    }

    .total-label {
        font-size: 16px;
        color: #666;
    }

    .total-amount {
        font-size: 24px;
        font-weight: 700;
        color: #333;
    }

    .button-section {
        padding: 20px;
        display: flex;
        gap: 10px;
    }

    .btn {
        flex: 1;
        padding: 15px;
        border: none;
        border-radius: 8px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .btn-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
    }

    .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }

    .btn-secondary {
        background: #6c757d;
        color: white;
    }

    .btn-secondary:hover {
        background: #5a6268;
        transform: translateY(-2px);
    }

    .loading {
        display: none;
        text-align: center;
        padding: 20px;
        color: #666;
    }

    .spinner {
        border: 3px solid #f3f3f3;
        border-top: 3px solid #667eea;
        border-radius: 50%;
        width: 30px;
        height: 30px;
        animation: spin 1s linear infinite;
        margin: 0 auto 10px;
    }

    @keyframes spin {
        0% {
            transform: rotate(0deg);
        }
        100% {
            transform: rotate(360deg);
        }
    }
</style>

<div class="container">
    <div class="header">
        <h1>🍕 주문 결제</h1>
        <p>맛있는 음식을 주문해보세요!</p>
        <p style="font-size: 12px; margin-top: 10px; opacity: 0.8;">로그인이 필요한 서비스입니다</p>
    </div>

    <div class="order-section" id="orderSection">
        <div class="loading-cart" id="loadingCart">
            <div class="spinner"></div>
            <p>장바구니 로딩 중...</p>
        </div>
    </div>

    <div class="total-section">
        <div class="total-row">
            <span class="total-label">총 결제금액</span>
            <span class="total-amount" id="totalAmount">4,500원</span>
        </div>
    </div>

    <div class="button-section">
        <button class="btn btn-secondary" onclick="cancelOrder()">결제 취소</button>
        <button class="btn btn-primary" onclick="processPayment()">결제하기</button>
    </div>

    <div class="loading" id="loading">
        <div class="spinner"></div>
        <p>결제 처리 중...</p>
    </div>
</div>

<script>
    let tossPayments;
    let cartItems = [];
    let totalAmount = 0;

    // 클라이언트 키 가져오기
    console.log('클라이언트 키 요청 시작...');
    fetch('/api/payment/client-key')
        .then(response => {
            console.log('API 응답 상태:', response.status, response.statusText);
            if (!response.ok) {
                throw new Error(`클라이언트 키 요청 실패: ${response.status} ${response.statusText}`);
            }
            return response.text();
        })
        .then(clientKey => {
            console.log('클라이언트 키 길이:', clientKey.length);

            if (!clientKey || !clientKey.trim()) {
                throw new Error('빈 클라이언트 키 받음');
            }

            const trimmedKey = clientKey.trim();
            console.log('정리된 클라이언트 키:', trimmedKey);

            try {
                tossPayments = TossPayments(trimmedKey);
            } catch (initError) {
                console.error('TossPayments 초기화 오류:', initError);
                throw new Error('TossPayments 초기화 실패: ' + initError.message);
            }
        })
        .catch(error => {
            console.error('전체 오류:', error);
            console.error('오류 스택:', error.stack);
            alert('결제 시스템 초기화 실패: ' + error.message);
        });

    // 장바구니 데이터 가져오기
    function loadCartItems() {
        console.log('장바구니 데이터 로드 시작...');

        fetch('/api/cart', {
            headers: {
                "Authorization": "Bearer " + localStorage.getItem("token")
            }
        })
            .then(response => {
                console.log('API 응답 상태:', response.status, response.statusText);
                console.log('API 응답 헤더:', response.headers);

                if (!response.ok) {
                    return response.text().then(text => {
                        console.error('오류 응답 내용:', text);
                        throw new Error(`장바구니 데이터 로드 실패: ${response.status} - ${text}`);
                    });
                }
                return response.json();
            })
            .then(data => {
                console.log('장바구니 데이터:', data);
                console.log('데이터 타입:', typeof data);
                console.log('데이터 길이:', data ? data.length : 'undefined');

                if (data && data.length > 0 && data[0].items && data[0].items.length > 0) {
                    cartItems = data[0].items;
                    console.log('장바구니 아이템 수:', cartItems.length);
                    displayCartItems();
                } else {
                    console.log('빈 장바구니 또는 데이터 없음');
                    displayEmptyCart();
                }
            })
            .catch(error => {
                console.error('장바구니 로드 오류:', error);
                console.error('오류 스택:', error.stack);
                displayEmptyCart();
            });
    }

    function displayCartItems() {
        const orderSection = document.getElementById('orderSection');
        const loadingCart = document.getElementById('loadingCart');

        if (loadingCart) {
            loadingCart.style.display = 'none';
        }

        let itemsHtml = '';
        totalAmount = 0;

        cartItems.forEach((item, index) => {
            const itemTotal = item.price * item.quantity;
            totalAmount += itemTotal;

            itemsHtml += `
                    <div class="menu-item">
                        <div class="menu-info">
                            <div class="menu-name">${item.menuName}</div>
                            <div class="menu-price">${item.price.toLocaleString()}원</div>
                        </div>
                        <div class="quantity-control">
                            <button class="quantity-btn" onclick="decreaseQuantity(${index})" ${item.quantity <= 1 ? 'disabled' : ''}>-</button>
                            <span class="quantity">${item.quantity}</span>
                            <button class="quantity-btn" onclick="increaseQuantity(${index})" ${item.quantity >= 10 ? 'disabled' : ''}>+</button>
                        </div>
                    </div>
                `;
        });

        orderSection.innerHTML = itemsHtml;
        updateTotalDisplay();
    }

    function displayEmptyCart() {
        const orderSection = document.getElementById('orderSection');
        const loadingCart = document.getElementById('loadingCart');

        if (loadingCart) {
            loadingCart.style.display = 'none';
        }
        orderSection.innerHTML = `
                <div style="text-align: center; padding: 40px; color: #666;">
                    <p>장바구니가 비어있습니다.</p>
                    <p>로그인 후 메뉴를 담고 결제해주세요.</p>
                    <p style="font-size: 12px; color: #999; margin-top: 10px;">
                        또는 장바구니를 불러올 수 없습니다.
                    </p>
                </div>
            `;

        // 결제 버튼 비활성화
        document.querySelector('.btn-primary').disabled = true;
    }

    function increaseQuantity(index) {
        if (cartItems[index].quantity < 10) {
            updateCartItemQuantity(cartItems[index].cartItemId, cartItems[index].quantity + 1, index);
        }
    }

    function decreaseQuantity(index) {
        if (cartItems[index].quantity > 1) {
            updateCartItemQuantity(cartItems[index].cartItemId, cartItems[index].quantity - 1, index);
        }
    }

    function updateCartItemQuantity(cartItemId, newQuantity, index) {
        fetch(`/api/cart/items/${cartItemId}?quantity=${newQuantity}`, {
            method: 'PATCH',
            headers: {
                "Authorization": "Bearer " + localStorage.getItem("token")
            }
        })
            .then(response => {
                if (response.ok) {
                    cartItems[index].quantity = newQuantity;
                    displayCartItems();
                } else {
                    alert('수량 업데이트에 실패했습니다.');
                }
            })
            .catch(error => {
                console.error('수량 업데이트 오류:', error);
                alert('수량 업데이트에 실패했습니다.');
            });
    }

    function updateTotalDisplay() {
        document.getElementById('totalAmount').textContent = totalAmount.toLocaleString() + '원';
    }

    function cancelOrder() {
        if (confirm('주문을 취소하시겠습니까?')) {
            alert('주문이 취소되었습니다.');
            window.history.back();
        }
    }

    function processPayment() {
        if (!tossPayments) {
            alert('결제 시스템이 아직 로드되지 않았습니다.');
            return;
        }

        if (cartItems.length === 0) {
            alert('장바구니가 비어있습니다.');
            return;
        }

        // 로딩 표시
        document.getElementById('loading').style.display = 'block';
        document.querySelector('.button-section').style.display = 'none';

        // 먼저 서버에 결제 준비 요청
        fetch('/api/payment/ready', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': 'Bearer ' + localStorage.getItem('token')
            },
            body: JSON.stringify({
                customerEmail: 'customer@example.com'
            })
        })
            .then(response => response.json())
            .then(paymentData => {
                console.log('결제 준비 응답:', paymentData);

                // 서버에서 받은 데이터로 결제 요청
                tossPayments.requestPayment('CARD', {
                    amount: paymentData.amount,
                    orderId: paymentData.orderId,
                    orderName: paymentData.orderName,
                    customerName: '고객',
                    customerEmail: 'customer@example.com',
                    successUrl: 'http://localhost:8080/api/payment/success',
                    failUrl: 'http://localhost:8080/api/payment/fail'
                });
            })
            .catch(error => {
                console.error('결제 준비 오류:', error);
                document.getElementById('loading').style.display = 'none';
                document.querySelector('.button-section').style.display = 'flex';
                alert('결제 준비 중 오류가 발생했습니다: ' + error.message);
            });
    }

    // 장바구니 로드
    loadCartItems();
</script>
</body>
</html>
